openapi: 3.0.0
info:
  title: HonkingVersion API
  description: API for HonkingVersion - A Goose music database and community platform
  version: 1.0.0
  contact:
    name: API Support
    url: https://honkingversion.runfoo.run
  license:
    name: MIT

servers:
  - url: https://api.honkingversion.runfoo.run
    description: Production server
  - url: http://localhost:8000
    description: Development server

tags:
  - name: Authentication
    description: User login and token management
  - name: Users
    description: User profiles and accounts
  - name: Shows
    description: Concert and show information
  - name: Songs
    description: Song catalog (originals and covers)
  - name: Performances
    description: Individual song performances at shows
  - name: Venues
    description: Venue information
  - name: Votes
    description: User ratings and reviews
  - name: Attended
    description: Shows marked as attended
  - name: Lists
    description: User-created lists of shows
  - name: Follows
    description: User follow relationships
  - name: Settings
    description: User account settings
  - name: Notifications
    description: User notifications and preferences
  - name: Export
    description: Data export functionality

paths:
  /auth/login:
    post:
      tags:
        - Authentication
      summary: User login
      description: Authenticate user and return access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  example: honkfan42
                password:
                  type: string
                  example: secure_password_123
              required:
                - username
                - password
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  token_type:
                    type: string
                    example: bearer
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Invalid credentials
        '400':
          description: Missing required fields

  /auth/register:
    post:
      tags:
        - Authentication
      summary: User registration
      description: Create a new user account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  minLength: 3
                  maxLength: 50
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 8
              required:
                - username
                - email
                - password
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Invalid input or user already exists
        '422':
          description: Validation error

  /users/me:
    get:
      tags:
        - Users
      summary: Get current user profile
      description: Retrieve the authenticated user's profile information
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Not authenticated

  /users/{username}:
    get:
      tags:
        - Users
      summary: Get user profile by username
      description: Retrieve public profile information for a specific user
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User profile retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          description: User not found

  /shows/{date}:
    get:
      tags:
        - Shows
      summary: Get show by date
      description: Retrieve detailed show information including setlist
      parameters:
        - name: date
          in: path
          required: true
          schema:
            type: string
            format: date
            example: '2024-07-20'
      responses:
        '200':
          description: Show details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Show'
        '404':
          description: Show not found

  /shows:
    get:
      tags:
        - Shows
      summary: List all shows
      description: Retrieve paginated list of all shows
      parameters:
        - name: skip
          in: query
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
        - name: venue
          in: query
          schema:
            type: string
        - name: tour
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of shows retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Show'

  /songs:
    get:
      tags:
        - Songs
      summary: List all songs
      description: Retrieve paginated list of songs (originals and covers)
      parameters:
        - name: skip
          in: query
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: is_cover
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: List of songs retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Song'

  /songs/{slug}:
    get:
      tags:
        - Songs
      summary: Get song by slug
      description: Retrieve detailed song information
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Song details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Song'
        '404':
          description: Song not found

  /songs/{slug}/performances:
    get:
      tags:
        - Songs
        - Performances
      summary: Get all performances of a song
      description: Retrieve all times a specific song was performed
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
        - name: skip
          in: query
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: Performance list retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Performance'

  /venues:
    get:
      tags:
        - Venues
      summary: List all venues
      description: Retrieve paginated list of all venues
      parameters:
        - name: skip
          in: query
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: search
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of venues retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Venue'

  /venues/{slug}:
    get:
      tags:
        - Venues
      summary: Get venue by slug
      description: Retrieve detailed venue information and all shows
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Venue details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Venue'
        '404':
          description: Venue not found

  /votes:
    get:
      tags:
        - Votes
      summary: List votes/reviews
      description: Retrieve paginated list of votes with optional filtering
      parameters:
        - name: skip
          in: query
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: song_id
          in: query
          schema:
            type: integer
        - name: show_id
          in: query
          schema:
            type: integer
        - name: min_rating
          in: query
          schema:
            type: number
        - name: max_rating
          in: query
          schema:
            type: number
        - name: reviewer
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of votes retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Vote'

    post:
      tags:
        - Votes
      summary: Create a new vote/review
      description: Submit a rating and optional review for a show or performance
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                target_type:
                  type: string
                  enum: [show, performance]
                target_id:
                  type: integer
                rating:
                  type: number
                  minimum: 1
                  maximum: 10
                review_text:
                  type: string
                  maxLength: 1000
              required:
                - target_type
                - target_id
                - rating
      responses:
        '201':
          description: Vote created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Vote'
        '400':
          description: Invalid input
        '401':
          description: Not authenticated

  /votes/{vote_id}:
    put:
      tags:
        - Votes
      summary: Update a vote
      description: Update an existing vote/review (only by author)
      security:
        - bearerAuth: []
      parameters:
        - name: vote_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                rating:
                  type: number
                  minimum: 1
                  maximum: 10
                review_text:
                  type: string
      responses:
        '200':
          description: Vote updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Vote'
        '401':
          description: Unauthorized
        '404':
          description: Vote not found

    delete:
      tags:
        - Votes
      summary: Delete a vote
      description: Delete a vote/review (only by author)
      security:
        - bearerAuth: []
      parameters:
        - name: vote_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Vote deleted successfully
        '401':
          description: Unauthorized
        '404':
          description: Vote not found

  /attended:
    get:
      tags:
        - Attended
      summary: Get attended shows
      description: Retrieve list of shows marked as attended by current user
      security:
        - bearerAuth: []
      parameters:
        - name: skip
          in: query
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: List of attended shows retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Show'
        '401':
          description: Not authenticated

    post:
      tags:
        - Attended
      summary: Mark show as attended
      description: Add a show to attended list
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                show_id:
                  type: integer
              required:
                - show_id
      responses:
        '201':
          description: Show marked as attended
        '400':
          description: Invalid show ID or already attended
        '401':
          description: Not authenticated

  /lists:
    get:
      tags:
        - Lists
      summary: List public lists
      description: Retrieve paginated list of public user lists
      parameters:
        - name: skip
          in: query
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: List of lists retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserList'

    post:
      tags:
        - Lists
      summary: Create a new list
      description: Create a new user list
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                  maxLength: 100
                description:
                  type: string
                  maxLength: 500
                list_type:
                  type: string
                  enum: [shows, performances, songs]
                items:
                  type: string
                  description: JSON array of item IDs
                is_public:
                  type: boolean
              required:
                - title
                - list_type
      responses:
        '201':
          description: List created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserList'
        '400':
          description: Invalid input
        '401':
          description: Not authenticated

  /lists/{list_id}:
    get:
      tags:
        - Lists
      summary: Get list details
      description: Retrieve a specific list with all items
      parameters:
        - name: list_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: List retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserList'
        '404':
          description: List not found

    put:
      tags:
        - Lists
      summary: Update a list
      description: Update list details (only by owner)
      security:
        - bearerAuth: []
      parameters:
        - name: list_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                description:
                  type: string
                items:
                  type: string
                is_public:
                  type: boolean
      responses:
        '200':
          description: List updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserList'
        '401':
          description: Unauthorized
        '404':
          description: List not found

    delete:
      tags:
        - Lists
      summary: Delete a list
      description: Delete a list (only by owner)
      security:
        - bearerAuth: []
      parameters:
        - name: list_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: List deleted successfully
        '401':
          description: Unauthorized
        '404':
          description: List not found

  /follows/{username}:
    post:
      tags:
        - Follows
      summary: Follow a user
      description: Start following another user
      security:
        - bearerAuth: []
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
      responses:
        '201':
          description: User followed successfully
        '400':
          description: Invalid user or already following
        '401':
          description: Not authenticated

    delete:
      tags:
        - Follows
      summary: Unfollow a user
      description: Stop following another user
      security:
        - bearerAuth: []
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: User unfollowed successfully
        '401':
          description: Not authenticated

  /settings/profile:
    get:
      tags:
        - Settings
      summary: Get profile settings
      description: Retrieve current user's profile settings
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Profile settings retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  display_name:
                    type: string
                  bio:
                    type: string
                  profile_picture_url:
                    type: string
        '401':
          description: Not authenticated

    put:
      tags:
        - Settings
      summary: Update profile settings
      description: Update display name, bio, and profile picture
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                display_name:
                  type: string
                  maxLength: 50
                bio:
                  type: string
                  maxLength: 500
      responses:
        '200':
          description: Profile settings updated
        '400':
          description: Invalid input
        '401':
          description: Not authenticated

  /settings/account/email:
    put:
      tags:
        - Settings
      summary: Change email address
      description: Change user's email address (requires password verification)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                new_email:
                  type: string
                  format: email
                password:
                  type: string
              required:
                - new_email
                - password
      responses:
        '200':
          description: Email changed successfully
        '400':
          description: Invalid email or password
        '401':
          description: Not authenticated

  /settings/account/password:
    put:
      tags:
        - Settings
      summary: Change password
      description: Change user's password
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                current_password:
                  type: string
                new_password:
                  type: string
                  minLength: 8
              required:
                - current_password
                - new_password
      responses:
        '200':
          description: Password changed successfully
        '400':
          description: Invalid current password or weak new password
        '401':
          description: Not authenticated

  /settings/privacy:
    get:
      tags:
        - Settings
      summary: Get privacy settings
      description: Retrieve user's privacy preferences
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Privacy settings retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  profile_visibility:
                    type: string
                    enum: [public, unlisted, private]
                  activity_visibility:
                    type: string
                    enum: [everyone, followers, private]
                  allow_messages:
                    type: string
                    enum: [everyone, followers, none]
                  show_stats:
                    type: boolean
                  indexable:
                    type: boolean
        '401':
          description: Not authenticated

    put:
      tags:
        - Settings
      summary: Update privacy settings
      description: Update user's privacy preferences
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                profile_visibility:
                  type: string
                  enum: [public, unlisted, private]
                activity_visibility:
                  type: string
                  enum: [everyone, followers, private]
                allow_messages:
                  type: string
                  enum: [everyone, followers, none]
                show_stats:
                  type: boolean
                indexable:
                  type: boolean
      responses:
        '200':
          description: Privacy settings updated
        '400':
          description: Invalid input
        '401':
          description: Not authenticated

  /notifications:
    get:
      tags:
        - Notifications
      summary: Get notifications
      description: Retrieve user's notifications
      security:
        - bearerAuth: []
      parameters:
        - name: skip
          in: query
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: unread_only
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: Notifications retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Notification'
        '401':
          description: Not authenticated

  /notifications/{notification_id}/mark-read:
    post:
      tags:
        - Notifications
      summary: Mark notification as read
      description: Mark a specific notification as read
      security:
        - bearerAuth: []
      parameters:
        - name: notification_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Notification marked as read
        '401':
          description: Not authenticated
        '404':
          description: Notification not found

  /export/me/csv:
    get:
      tags:
        - Export
      summary: Export user data as CSV
      description: Download complete user data in CSV format
      security:
        - bearerAuth: []
      responses:
        '200':
          description: CSV export file
          content:
            text/csv:
              schema:
                type: string
        '401':
          description: Not authenticated

components:
  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
        username:
          type: string
        email:
          type: string
          format: email
        display_name:
          type: string
        bio:
          type: string
        profile_picture_url:
          type: string
        created_at:
          type: string
          format: date-time
        followers_count:
          type: integer
        following_count:
          type: integer
        is_verified:
          type: boolean

    Show:
      type: object
      properties:
        id:
          type: integer
        date:
          type: string
          format: date
        venue:
          type: string
        location:
          type: string
        setlist:
          type: array
          items:
            type: object
            properties:
              set_number:
                type: integer
              song:
                $ref: '#/components/schemas/Song'
              performance_id:
                type: integer
        attendees_count:
          type: integer
        average_rating:
          type: number

    Song:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        slug:
          type: string
        is_cover:
          type: boolean
        original_artist:
          type: string
        first_appearance:
          type: string
          format: date
        times_performed:
          type: integer
        average_rating:
          type: number

    Performance:
      type: object
      properties:
        id:
          type: integer
        song_id:
          type: integer
        show_id:
          type: integer
        set_number:
          type: integer
        notes:
          type: string
        rating:
          type: number
        votes_count:
          type: integer
        average_rating:
          type: number

    Venue:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        slug:
          type: string
        city:
          type: string
        state:
          type: string
        country:
          type: string
        shows_count:
          type: integer

    Vote:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        target_type:
          type: string
          enum: [show, performance]
        target_id:
          type: integer
        rating:
          type: number
          minimum: 1
          maximum: 10
        review_text:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    UserList:
      type: object
      properties:
        id:
          type: integer
        owner_id:
          type: integer
        title:
          type: string
        description:
          type: string
        list_type:
          type: string
          enum: [shows, performances, songs]
        items:
          type: array
        is_public:
          type: boolean
        created_at:
          type: string
          format: date-time

    Notification:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        type:
          type: string
        title:
          type: string
        message:
          type: string
        read:
          type: boolean
        created_at:
          type: string
          format: date-time

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
